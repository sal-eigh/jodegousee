{"version":3,"file":"head-export-handler-for-browser.js","names":["hiddenRoot","document","createElement","keysOfHtmlAndBodyAttributes","html","body","onHeadRendered","validHeadNodes","htmlAndBodyAttributes","getValidHeadNodesAndAttributes","Object","keys","applyHtmlAndBodyAttributes","existingHeadElements","querySelectorAll","length","head","append","newHeadNodes","diffNodes","oldNodes","newNodes","onStale","node","parentNode","removeChild","onNew","push","process","env","BUILD_STAGE","originalConsoleError","console","error","bind","args","Array","isArray","includes","undefined","observer","MutationObserver","observe","attributes","childList","characterData","subtree","reactMajor","parseInt","React","version","split","headPatched","originalCreateElement","validHeadComponentReplacements","getValidHeadComponentReplacements","patchedCreateElement","type","props","rest","headReplacement","get","call","headHandlerForBrowser","pageComponent","staticQueryResults","pageComponentProps","useEffect","Head","headExportValidator","render","reactDOMUtils","HeadElement","filterHeadProps","WrapHeadElement","apiRunner","element","result","pop","removePrevHeadElements","removeHtmlAndBodyAttributes"],"sources":["../../head/head-export-handler-for-browser.js"],"sourcesContent":["import React from \"react\"\nimport { useEffect } from \"react\"\nimport { StaticQueryContext } from \"gatsby\"\nimport { LocationProvider } from \"@gatsbyjs/reach-router\"\n\nimport { reactDOMUtils } from \"../react-dom-utils\"\nimport { FireCallbackInEffect } from \"./components/fire-callback-in-effect\"\nimport {\n  IsHeadRenderContext,\n  getValidHeadComponentReplacements,\n} from \"./components/head-components\"\nimport {\n  headExportValidator,\n  filterHeadProps,\n  diffNodes,\n  getValidHeadNodesAndAttributes,\n  removePrevHeadElements,\n  applyHtmlAndBodyAttributes,\n  removeHtmlAndBodyAttributes,\n} from \"./utils\"\nimport { apiRunner } from \"../api-runner-browser\"\n\nconst hiddenRoot = document.createElement(`div`)\nconst keysOfHtmlAndBodyAttributes = {\n  html: [],\n  body: [],\n}\n\nconst onHeadRendered = () => {\n  const { validHeadNodes, htmlAndBodyAttributes } =\n    getValidHeadNodesAndAttributes(hiddenRoot)\n\n  keysOfHtmlAndBodyAttributes.html = Object.keys(htmlAndBodyAttributes.html)\n  keysOfHtmlAndBodyAttributes.body = Object.keys(htmlAndBodyAttributes.body)\n\n  applyHtmlAndBodyAttributes(htmlAndBodyAttributes)\n\n  /**\n   * The rest of the code block below is a diffing mechanism to ensure that\n   * the head elements aren't duplicated on every re-render.\n   */\n  const existingHeadElements = document.querySelectorAll(`[data-gatsby-head]`)\n\n  if (existingHeadElements.length === 0) {\n    document.head.append(...validHeadNodes)\n    return\n  }\n\n  const newHeadNodes = []\n  diffNodes({\n    oldNodes: existingHeadElements,\n    newNodes: validHeadNodes,\n    onStale: node => node.parentNode.removeChild(node),\n    onNew: node => newHeadNodes.push(node),\n  })\n\n  document.head.append(...newHeadNodes)\n}\n\nif (process.env.BUILD_STAGE === `develop`) {\n  // sigh ... <html> and <body> elements are not valid descedents of <div> (our hidden element)\n  // react-dom in dev mode will warn about this. There doesn't seem to be a way to render arbitrary\n  // user Head without hitting this issue (our hidden element could be just \"new Document()\", but\n  // this can only have 1 child, and we don't control what is being rendered so that's not an option)\n  // instead we continue to render to <div>, and just silence warnings for <html> and <body> elements\n  // https://github.com/facebook/react/blob/e2424f33b3ad727321fc12e75c5e94838e84c2b5/packages/react-dom-bindings/src/client/validateDOMNesting.js#L498-L520\n  const originalConsoleError = console.error.bind(console)\n  console.error = (...args) => {\n    if (\n      Array.isArray(args) &&\n      args.length >= 2 &&\n      args[0]?.includes?.(`validateDOMNesting(...): %s cannot appear as`) &&\n      (args[1] === `<html>` || args[1] === `<body>`)\n    ) {\n      return undefined\n    }\n    return originalConsoleError(...args)\n  }\n\n  /* We set up observer to be able to regenerate <head> after react-refresh\n     updates our hidden element.\n  */\n  const observer = new MutationObserver(onHeadRendered)\n  observer.observe(hiddenRoot, {\n    attributes: true,\n    childList: true,\n    characterData: true,\n    subtree: true,\n  })\n}\n\n// React 19 does not allow rendering a second `<html>` or `<body>` anywhere in the tree:\n// https://github.com/facebook/react/blob/50e7ec8a694072fd6fcd52182df8a75211bf084d/packages/react-dom-bindings/src/server/ReactFizzConfigDOM.js#L3739\n// Unfortunately, our Head API relies on users being able to render these elements, which we then\n// render in a hidden `<div>` to extract attributes to apply to the real `<html>` and `<body>`.\n// We explored several alternatives, but none were viable given React's constraints.\n// To work around this, we intercept attempts to render these elements inside of\n// Head and replace them with custom components that render as `<div>`s with a\n// `data-original-tag` attribute. We can then use this attribute later to apply\n// attributes to the real `<html>` and `<body>` elements.\n// Additionally other head elements are subject to React's new hoisting behavior,\n// which has some differences from how Gatsby Head API works, so we do append `itemProp`\n// which prevents React from hoisting those elements:\n// https://github.com/facebook/react/blob/50e7ec8a694072fd6fcd52182df8a75211bf084d/packages/react-dom-bindings/src/client/ReactFiberConfigDOM.js#L5824\n// we later will remove this attribute if it has our custom value before appending to real head.\n\n// De-risk monkey patch by only applying it when needed (React 19+, not React 18)\nconst reactMajor = parseInt(React.version.split(`.`)[0], 10)\nif (reactMajor !== 18 && !React.createElement.headPatched) {\n  const originalCreateElement = React.createElement\n  const validHeadComponentReplacements = getValidHeadComponentReplacements(\n    originalCreateElement,\n    false\n  )\n  React.createElement = function patchedCreateElement(type, props, ...rest) {\n    const headReplacement = validHeadComponentReplacements.get(type)\n    if (headReplacement) {\n      type = headReplacement\n    }\n\n    return originalCreateElement.call(React, type, props, ...rest)\n  }\n\n  React.createElement.headPatched = true\n}\nexport function headHandlerForBrowser({\n  pageComponent,\n  staticQueryResults,\n  pageComponentProps,\n}) {\n  useEffect(() => {\n    if (pageComponent?.Head) {\n      headExportValidator(pageComponent.Head)\n\n      const { render } = reactDOMUtils()\n\n      const HeadElement = (\n        <pageComponent.Head {...filterHeadProps(pageComponentProps)} />\n      )\n\n      const WrapHeadElement = apiRunner(\n        `wrapRootElement`,\n        { element: HeadElement },\n        HeadElement,\n        ({ result }) => {\n          return { element: result }\n        }\n      ).pop()\n\n      render(\n        // just a hack to call the callback after react has done first render\n        // Note: In dev, we call onHeadRendered twice( in FireCallbackInEffect and after mutualution observer dectects initail render into hiddenRoot) this is for hot reloading\n        // In Prod we only call onHeadRendered in FireCallbackInEffect to render to head\n        <FireCallbackInEffect callback={onHeadRendered}>\n          <IsHeadRenderContext.Provider value={true}>\n            <StaticQueryContext.Provider value={staticQueryResults}>\n              <LocationProvider>{WrapHeadElement}</LocationProvider>\n            </StaticQueryContext.Provider>\n          </IsHeadRenderContext.Provider>\n        </FireCallbackInEffect>,\n        hiddenRoot\n      )\n    }\n\n    return () => {\n      removePrevHeadElements()\n      removeHtmlAndBodyAttributes(keysOfHtmlAndBodyAttributes)\n    }\n  })\n}\n"],"mappings":"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"}