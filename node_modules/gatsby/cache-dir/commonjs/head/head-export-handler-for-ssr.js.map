{"version":3,"file":"head-export-handler-for-ssr.js","names":["React","require","grabMatchParams","StaticQueryContext","headExportValidator","filterHeadProps","isElementType","isValidNodeName","warnForInvalidTag","ServerLocation","Router","renderToString","parse","styleToOjbect","applyHtmlAndBodyAttributesSSR","htmlAndBodyAttributes","setHtmlAttributes","setBodyAttributes","html","body","getValidHeadNodesAndAttributesSSR","rootNode","seenIds","Map","validHeadNodes","node","childNodes","rawTagName","id","attributes","NodeName","HTML_BODY_ORIGINAL_TAG_ATTRIBUTE_KEY","style","nonStyleAttributes","element","ITEM_PROP_WORKAROUND_KEY","ITEM_PROP_WORKAROUND_VALUE","__html","text","textContent","length","has","push","set","indexOfPreviouslyInsertedNode","get","applyCreateElementPatch","undefined","revertCreateElementPatch","needToRevertCreateElementPatch","reactMajor","parseInt","version","split","originalCreateElement","createElement","validHeadComponentReplacements","getValidHeadComponentReplacements","patchedCreateElement","type","props","rest","headReplacement","call","headHandlerForSSR","pageComponent","setHeadComponents","staticQueryContext","pageData","pagePath","Head","HeadRouteHandler","_props","result","params","location","pathname","pageContext","__params","HeadElement","headWithWrapRootElement","apiRunner","pop","routerElement","__BASE_PATH__","children","rawString","e"],"sources":["../../head/head-export-handler-for-ssr.js"],"sourcesContent":["const React = require(`react`)\nconst { grabMatchParams } = require(`../find-path`)\nconst { StaticQueryContext } = require(`gatsby`)\nconst {\n  headExportValidator,\n  filterHeadProps,\n  isElementType,\n  isValidNodeName,\n  warnForInvalidTag,\n} = require(`./utils`)\nconst { ServerLocation, Router } = require(`@gatsbyjs/reach-router`)\nconst { renderToString } = require(`react-dom/server`)\nconst { parse } = require(`node-html-parser`)\nconst styleToOjbect = require(`style-to-object`)\n\nimport {\n  ITEM_PROP_WORKAROUND_KEY,\n  ITEM_PROP_WORKAROUND_VALUE,\n  HTML_BODY_ORIGINAL_TAG_ATTRIBUTE_KEY,\n} from \"./constants\"\nimport { getValidHeadComponentReplacements } from \"./components/head-components\"\nimport { apiRunner } from \"../api-runner-ssr\"\n\nexport function applyHtmlAndBodyAttributesSSR(\n  htmlAndBodyAttributes,\n  { setHtmlAttributes, setBodyAttributes }\n) {\n  if (!htmlAndBodyAttributes) return\n\n  const { html, body } = htmlAndBodyAttributes\n\n  setHtmlAttributes(html)\n  setBodyAttributes(body)\n}\n\nexport function getValidHeadNodesAndAttributesSSR(\n  rootNode,\n  htmlAndBodyAttributes = {\n    html: {},\n    body: {},\n  }\n) {\n  const seenIds = new Map()\n  const validHeadNodes = []\n\n  // Filter out non-element nodes before looping since we don't care about them\n  for (const node of rootNode.childNodes) {\n    const { rawTagName } = node\n    const id = node.attributes?.id\n\n    if (!isElementType(node)) continue\n\n    const NodeName =\n      node.attributes?.[HTML_BODY_ORIGINAL_TAG_ATTRIBUTE_KEY] ?? rawTagName\n\n    if (isValidNodeName(NodeName)) {\n      if (NodeName === `html` || NodeName === `body`) {\n        const { style, ...nonStyleAttributes } = node.attributes\n\n        htmlAndBodyAttributes[NodeName] = {\n          ...htmlAndBodyAttributes[NodeName],\n          ...nonStyleAttributes,\n        }\n\n        // Unfortunately renderToString converts inline styles to a string, so we have to convert them back to an object\n        if (style) {\n          htmlAndBodyAttributes[NodeName].style = {\n            ...htmlAndBodyAttributes[NodeName]?.style,\n            ...styleToOjbect(style),\n          }\n        }\n      } else {\n        let element\n        const attributes = { ...node.attributes, \"data-gatsby-head\": true }\n\n        if (\n          attributes[ITEM_PROP_WORKAROUND_KEY] === ITEM_PROP_WORKAROUND_VALUE\n        ) {\n          delete attributes[ITEM_PROP_WORKAROUND_KEY]\n        }\n\n        if (NodeName === `script` || NodeName === `style`) {\n          element = (\n            <NodeName\n              {...attributes}\n              dangerouslySetInnerHTML={{\n                __html: node.text,\n              }}\n            />\n          )\n        } else {\n          element =\n            node.textContent.length > 0 ? (\n              <NodeName {...attributes}>{node.textContent}</NodeName>\n            ) : (\n              <NodeName {...attributes} />\n            )\n        }\n\n        if (id) {\n          if (!seenIds.has(id)) {\n            validHeadNodes.push(element)\n            seenIds.set(id, validHeadNodes.length - 1)\n          } else {\n            const indexOfPreviouslyInsertedNode = seenIds.get(id)\n            validHeadNodes[indexOfPreviouslyInsertedNode] = element\n          }\n        } else {\n          validHeadNodes.push(element)\n        }\n      }\n    } else {\n      warnForInvalidTag(rawTagName)\n    }\n\n    if (node.childNodes.length) {\n      validHeadNodes.push(\n        ...getValidHeadNodesAndAttributesSSR(node, htmlAndBodyAttributes)\n          .validHeadNodes\n      )\n    }\n  }\n\n  return { validHeadNodes, htmlAndBodyAttributes }\n}\n\n// see explanation in \"head-export-handler-for-browser.js\" module for reasons behind this patching\nlet applyCreateElementPatch = undefined\nlet revertCreateElementPatch = undefined\nlet needToRevertCreateElementPatch = false\n\nconst reactMajor = parseInt(React.version.split(`.`)[0], 10)\nif (reactMajor !== 18) {\n  const originalCreateElement = React.createElement\n  const validHeadComponentReplacements = getValidHeadComponentReplacements(\n    originalCreateElement,\n    true\n  )\n\n  function patchedCreateElement(type, props, ...rest) {\n    const headReplacement = validHeadComponentReplacements.get(type)\n    if (headReplacement) {\n      type = headReplacement\n    }\n\n    return originalCreateElement.call(React, type, props, ...rest)\n  }\n\n  applyCreateElementPatch = () => {\n    needToRevertCreateElementPatch = true\n    React.createElement = patchedCreateElement\n  }\n\n  revertCreateElementPatch = () => {\n    if (needToRevertCreateElementPatch) {\n      React.createElement = originalCreateElement\n      needToRevertCreateElementPatch = false\n    }\n  }\n}\n\n// if this sync function is changed to async one, make sure to cover potential React.createElement patching as\n// current handling relies on it being sync and we can just modify React.createElement temporarily without checking context of render\n// (check how it's done in \"head-export-handler-for-browser.js\" module for potential solution)\nexport function headHandlerForSSR({\n  pageComponent,\n  setHeadComponents,\n  setHtmlAttributes,\n  setBodyAttributes,\n  staticQueryContext,\n  pageData,\n  pagePath,\n}) {\n  if (pageComponent?.Head) {\n    try {\n      headExportValidator(pageComponent.Head)\n\n      function HeadRouteHandler(props) {\n        const _props = {\n          ...props,\n          ...pageData.result,\n          params: {\n            ...grabMatchParams(props.location.pathname),\n            ...(pageData.result?.pageContext?.__params || {}),\n          },\n        }\n\n        const HeadElement = <pageComponent.Head {...filterHeadProps(_props)} />\n\n        const headWithWrapRootElement = apiRunner(\n          `wrapRootElement`,\n          { element: HeadElement },\n          HeadElement,\n          ({ result }) => {\n            return { element: result }\n          }\n        ).pop()\n\n        return headWithWrapRootElement\n      }\n\n      const routerElement = (\n        <StaticQueryContext.Provider value={staticQueryContext}>\n          <ServerLocation url={`${__BASE_PATH__}${pagePath}`}>\n            <Router\n              baseuri={__BASE_PATH__}\n              component={({ children }) => <>{children}</>}\n            >\n              <HeadRouteHandler path=\"/*\" />\n            </Router>\n          </ServerLocation>\n        </StaticQueryContext.Provider>\n      )\n\n      applyCreateElementPatch?.()\n\n      const rawString = renderToString(routerElement)\n\n      revertCreateElementPatch?.()\n\n      const rootNode = parse(rawString)\n      const { validHeadNodes, htmlAndBodyAttributes } =\n        getValidHeadNodesAndAttributesSSR(rootNode)\n\n      applyHtmlAndBodyAttributesSSR(htmlAndBodyAttributes, {\n        setHtmlAttributes,\n        setBodyAttributes,\n      })\n\n      setHeadComponents(validHeadNodes)\n    } catch (e) {\n      // make sure that we don't leave this function without reverting the patch\n      revertCreateElementPatch?.()\n      throw e\n    }\n  }\n}\n"],"mappings":"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"}